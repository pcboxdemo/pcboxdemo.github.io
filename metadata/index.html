<!DOCTYPE html>
<html lang="en">
<head>
    <!-- GoatCounter Analytics -->
    <script data-goatcounter="https://pcdemo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Folders, files and metadata exporter</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Connection Status Styles -->
    <link rel="stylesheet" href="connection-status.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
            .row {
                display: flex;
                justify-content: space-between;
            }
        
            .row > div {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 150px; /* Adjust height as needed */
                margin: 0 5px; /* Small gap between boxes */
            }
        
            .row > div:first-child {
                margin-left: 0;
            }
        
            .row > div:last-child {
                margin-right: 0;
            }
        
            .box {
                text-align: center;
                padding: 20px;
                background-color: #f8f9fa;
                border: 1px solid #ddd;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        

        .box:hover {
            background-color: #007bff;
            color: white;
            text-decoration: none;
        }
        a {
            text-decoration: none;
          }

        .logo-row {
            margin-top: 80px;
        }

        /* Connection status styles are now in connection-status.css */
    </style>
    <script>
        var params = new URLSearchParams(window.location.search);
        $(document).ready(function() {
            // Clean up old token format
            cleanupOldTokens();
            
            // Check connection status on page load
            updateConnectionStatus();
            
            $(".container").hide();
            var params = new URLSearchParams(window.location.search);
            var token = params.get('token');
            var code = params.get('code');
          
            if(code!=null) {
             sessionStorage.setItem("host","https://box-tokenegenrator-v2.herokuapp.com")
            
            $.ajax({
              method: 'get',
              //url: "https://bl2vhdoqzh.execute-api.eu-west-2.amazonaws.com/default/box-tokengenerator",
              url:"https://dik4ogwqph.execute-api.eu-west-2.amazonaws.com/default/box-node-token-generator",
      
            data: {authCode:code,clientId:params.get('clientId')},
              crossDomain: true,
              cache: false,
              success: function(response) {
               $("#loader").hide();
               sessionStorage.setItem("token",response.token);
               sessionStorage.setItem("refreshToken",response.refreshToken);
               
               // Store token hash for future authentication
               if(response.tokenHash) {
                 localStorage.setItem("tokenHash", response.tokenHash);
                 localStorage.setItem("userEmail", response.userEmail);
                 localStorage.setItem("lastAuthTime", Date.now());
               }
               
               // Re-initialize token validation with new tokens (force reset to re-validate)
               if (window.TokenManager && typeof window.TokenManager.initializeTokenValidation === 'function') {
                 window.TokenManager.initializeTokenValidation(true).then((token) => {
                   console.log("âœ… OAuth tokens stored, token validation complete:", token ? "valid" : "invalid");
                   // Update connection status after token validation completes
                   updateConnectionStatus();
                   // Trigger token validated event
                   if (token) {
                     $(document).trigger('tokenValidated', [token]);
                   } else {
                     $(document).trigger('tokenValidationFailed');
                   }
                 });
               } else {
                 // Update connection status after successful login
                 updateConnectionStatus();
               }
               
               $("#loader").hide();
               $(".container").show();
               if(localStorage.getItem("agentId")!=null) {
                window.location.href = "/metadata/agents.html";
               }
               
               
              },
              error: function(err) {
                console.log(JSON.stringify(err));
                console.log("error:" + err.message);
                $(".container").show();

                $(".container").text("an error happened:" + err.message);
      
              }
            });
        }
        else {
            $("#loader").hide();
            $(".container").show();
            if(sessionStorage.getItem("token")==null) {
                sessionStorage.setItem("token",token);
            }
            
        }

      
          });

        // Connection status functionality is now in connection-status.js
    </script>
</head>
<body>
    <img src="ajax-loader.gif" id="loader"/>
    <div class="container text-center mt-5">
        <h1 class="mb-4">I want to...</h1>
        <div class="row">
            <div>
                <a href="export.html" class="box d-block">
                    Export a folder structure with metadata
                </a>
            </div>
            <div>
                <a href="import.html" class="box d-block">
                    Import a folder structure with metadata
                </a>
            </div>
            <div>
                <a href="apply.html" class="box d-block">
                    Use API and AI to apply metadata to a large data set
                </a>
            </div>
            <div>
                <a href="delete.html" class="box d-block">
                    Delete a metadata template
                </a>
            </div>
            <div>
                <a href="docgen.html" class="box d-block">
                    Use DocGen and AI to generate documents
                </a>
            </div>
            <div>
                <a href="agents.html" class="box d-block">
                    Use the AI Agent Sharing Hub
                </a>
            </div>
            <div>
                <a href="taxonomies.html" class="box d-block">
                    Create, edit and share taxonomies
                </a>
            </div>
        </div>
        <div class="row logo-row">
            <div class="col-md-12 align-center">
                <img src="pppanic.png" alt="Panic! at the Box" class="logo" width="500"  />
            </div>

        </div>
    </div>

    <!-- Connection Status HTML -->
    <div id="connectionStatusContainer"></div> 

    <!-- Bootstrap JS and dependencies -->
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Connection Status JavaScript -->
    <script src="token-manager.js"></script>
    <script src="connection-status.js"></script>
    <script>
        // Load connection status HTML
        $(document).ready(function() {
            console.log("Loading connection status HTML...");
            $('#connectionStatusContainer').load('connection-status.html', function(response, status, xhr) {
                console.log("Connection status HTML load result:", {
                    status: status,
                    responseLength: response.length,
                    buttonFound: $('.connection-status-btn').length
                });
                
                if (status === "success") {
                    console.log("Connection status HTML loaded successfully, updating status...");
                    // Update connection status after HTML is loaded
                    if (typeof updateConnectionStatus === 'function') {
                        setTimeout(updateConnectionStatus, 100);
                    }
                } else {
                    console.error("Failed to load connection status HTML:", status, xhr);
                }
            });
        });
    </script>
</body>
</html>
