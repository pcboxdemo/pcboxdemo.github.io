
<!--
Author: W3layouts
Author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE html>
<html lang="en">
<head>
<title>File Version Comparison</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<!-- Box UI Elements Preview CSS -->
<link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/17.1.0/en-US/preview.css">
<!-- Custom CSS -->
<link rel="stylesheet" href="compare.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn01.boxcdn.net/platform/elements/21.0.0/en-US/preview.js"></script>
    <script>
  var params = new URLSearchParams(window.location.search);
  var clientId = params.get("clientId");
  var accessToken=params.get('token');
  var fileId = params.get('id');
  var fileExt = params.get('ext');
  var selectedVersions = [];
  var versionsData = [];
  var currentFileVersionId = null;
  var boxPreviewInstance = null;
  var boxPreviewLoaded = false;
  var currentPreviewVersionIndex = -1;
  var timeFilterDays = 30; // Default to showing last 30 days
  
  $(document).ready(function(){

      $.ajax({
      method: 'get',
          url: "https://dik4ogwqph.execute-api.eu-west-2.amazonaws.com/default/box-node-token-generator",
      data: {authCode: params.get('auth'), id: params.get('id'), clientId: params.get('clientId')},
          crossDomain: true,
      timeout: 120000,
          cache: false,
          beforeSend: function() {
              $('#loader').show();
           },
           complete: function(){
              $('#loader').hide();
          },
      success: function(response){
        console.log("**Success:** " + JSON.stringify(response));
            accessToken = response.token;
        getFileName(accessToken, fileId).then(function(result) {
          loadVersions(result);
        });
      },
      error: function(err){
        console.log("**Error:** " + JSON.stringify(err));
        console.log("**Error message:** " + err.message);
        getFileName(accessToken, fileId).then(function(result) {
              loadVersions(result);
            });
          }
      });
   });
  

  
  async function getFileName(accessToken, fileId) {
    return $.ajax({
      url: 'https://api.box.com/2.0/files/' + fileId + '?fields=id,name,modified_at,file_version',
      headers: {"Authorization": "Bearer " + accessToken},
      type: 'get',
      data: {},
      success: function(response) {
        // Store current file version ID
        if (response.file_version && response.file_version.id) {
          currentFileVersionId = response.file_version.id;
        }
        return response;
      }
    });
   }
  
  function formatDate(dateString) {
    if (!dateString) return 'Unknown date';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + ' minute' + (diffMins > 1 ? 's' : '') + ' ago';
    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
    if (diffDays < 7) return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
    
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  function loadVersions(fileInfo) {
    console.log("**Loading versions for file:** " + JSON.stringify(fileInfo));
    var url = "https://api.box.com/2.0/files/" + fileId + "/versions?fields=id,name,created_at,modified_at,size,modified_by";
    
    // Display file name
    var fileName = fileInfo.name || 'File Versions';
    $("#fileNameDisplay").text(fileName);
    $("#fileNameDisplay").data('original-name', fileName);
    
    // Get current file info with modified_by for current version
     $.ajax({
      url: 'https://api.box.com/2.0/files/' + fileId + '?fields=id,name,modified_at,modified_by',
      headers: {"Authorization": "Bearer " + accessToken},
      type: 'get',
      success: function(fileResponse) {
        // Add current version to versions array
        var currentVersion = {
          id: fileId,
          name: fileInfo.name,
          versionNumber: 0,
          created_at: fileInfo.modified_at,
          modified_at: fileInfo.modified_at,
          extension: fileExt,
          isCurrent: true,
          modified_by: fileResponse.modified_by || null
        };
        versionsData.push(currentVersion);
        
        // Now fetch version history
     $.ajax({
      url: url,
          headers: {"Authorization": "Bearer " + accessToken},
      type: 'get',
          data: {},
      success: function(response) {
            console.log("**Fetched versions:** " + response.entries.length);
            
            // Process versions (they come in reverse chronological order)
            var totalVersions = response.entries.length;
            var versionNum = totalVersions;
            
          $.each(response.entries, function(k, data) {
              var extension = data.name ? data.name.substr((data.name.lastIndexOf('.') + 1)) : fileExt;
              var versionInfo = {
                id: data.id,
                name: data.name,
                versionNumber: versionNum,
                created_at: data.created_at,
                modified_at: data.modified_at || data.created_at,
                extension: extension,
                isCurrent: false,
                modified_by: data.modified_by || null
              };
              versionsData.push(versionInfo);
              versionNum--;
            });
            
            // Update current version number
            currentVersion.versionNumber = totalVersions + 1;
            
            // Sort by version number descending (newest first)
            versionsData.sort(function(a, b) {
              return b.versionNumber - a.versionNumber;
            });
            
        // Populate time filter dropdown
        populateTimeFilterDropdown();
        
        // Apply time filter
        applyTimeFilter();
          },
          error: function(xhr, status, error) {
            console.log("**Error fetching versions:** " + JSON.stringify(xhr));
            $(".version-list-container").html('<div class="empty-state">Failed to load versions. Please try again.</div>');
          }
        });
      },
      error: function(xhr) {
        console.log("**Error fetching current file info:** " + JSON.stringify(xhr));
        // Continue anyway with null created_by
        var currentVersion = {
          id: fileId,
          name: fileInfo.name,
          versionNumber: 0,
          created_at: fileInfo.modified_at,
          modified_at: fileInfo.modified_at,
          extension: fileExt,
          isCurrent: true,
          modified_by: null
        };
        versionsData.push(currentVersion);
      }
    });
  }
  
  function populateTimeFilterDropdown() {
    var dropdown = $('#timeFilterSelect');
    dropdown.empty();
    
    // Time-based options
    var timeOptions = [
      { value: 7, text: 'Last 7 days' },
      { value: 30, text: 'Last 30 days' },
      { value: 90, text: 'Last 90 days' },
      { value: 0, text: 'All versions' }
    ];
    
    $.each(timeOptions, function(index, option) {
      var optionElement = $('<option/>')
        .val(option.value)
        .text(option.text);
      
      if (option.value === timeFilterDays) {
        optionElement.prop('selected', true);
      }
      
      dropdown.append(optionElement);
    });
  }
  
  function applyTimeFilter() {
    // Filter versions based on time filter
    var displayVersions;
    
    if (timeFilterDays === 0) {
      // Show all versions
      displayVersions = versionsData.slice();
    } else {
      // Filter by date
      var cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - timeFilterDays);
      
      displayVersions = versionsData.filter(function(version) {
        var versionDate = new Date(version.modified_at || version.created_at);
        return versionDate >= cutoffDate;
      });
    }
    
    renderVersions(displayVersions);
    updateCompareButton();
  }
  
  function groupVersionsByUser(versions) {
    // Group consecutive versions by the same user (same email)
    var groups = [];
    var currentGroup = null;
    
    $.each(versions, function(index, version) {
      var userEmail = '';
      if (version.modified_by) {
        userEmail = version.modified_by.login || '';
      }
      
      if (!currentGroup || currentGroup.userEmail !== userEmail) {
        // Start a new group
        currentGroup = {
          userEmail: userEmail,
          versions: [version],
          startIndex: index
        };
        groups.push(currentGroup);
      } else {
        // Add to current group
        currentGroup.versions.push(version);
      }
    });
    
    return groups;
  }
  
  function renderVersions(versions) {
    var container = $(".version-list-container");
    container.empty();
    
    if (versions.length === 0) {
      container.html('<div class="empty-state">No versions available</div>');
      return;
    }
    
    // Group consecutive versions by same user
    var versionGroups = groupVersionsByUser(versions);
    
    // Create timeline wrapper
    var timelineWrapper = $('<div/>').addClass('version-timeline-wrapper');
    var leftColumn = $('<div/>').addClass('version-column left');
    var rightColumn = $('<div/>').addClass('version-column right');
    
    timelineWrapper.append(leftColumn);
    timelineWrapper.append(rightColumn);
    
    // Track positions for drawing lines - store all versions in order
    var versionCards = [];
    var previousIsBoxDemo = null;
    var globalIndex = 0;
    
    // Render each group
    $.each(versionGroups, function(groupIndex, group) {
      var isCollapsed = group.versions.length > 1;
      var displayVersions = isCollapsed ? [group.versions[0]] : group.versions;
      
      // First pass: create cards for this group
      $.each(displayVersions, function(index, version) {
      // Determine user email and domain
      var userEmail = '';
      var userName = 'Unknown User';
      var isBoxDemo = false;
      
      if (version.modified_by) {
        userName = version.modified_by.name || 'Unknown User';
        userEmail = version.modified_by.login || '';
        isBoxDemo = userEmail.toLowerCase().endsWith('@boxdemo.com');
      }
      
      // Determine which column
      var targetColumn = isBoxDemo ? leftColumn : rightColumn;
      
      // Create version card
      var versionCard = $('<div/>')
        .addClass('version-card')
        .attr('data-version-id', version.id)
        .attr('data-version-ext', version.extension)
        .attr('data-is-boxdemo', isBoxDemo)
        .attr('data-version-order', index);
      
      var versionHeader = $('<div/>').addClass('version-header');
      
      var versionInfo = $('<div/>').addClass('version-info');
      
      // Line 1: Version number and date together
      var versionNumberDate = $('<div/>').addClass('version-number-date');
      var versionText = 'Version ' + version.versionNumber;
      if (isCollapsed && index === 0) {
        // Show count for collapsed group
        var oldestVersion = group.versions[group.versions.length - 1];
        versionText += ' - ' + oldestVersion.versionNumber + ' (' + group.versions.length + ' versions)';
      }
      if (version.isCurrent) {
        versionText += ' (Current)';
      }
      var versionNumber = $('<span/>')
        .addClass('version-number')
        .text(versionText);
      var versionDate = $('<span/>')
        .addClass('version-date')
        .text(formatDate(version.modified_at));
      versionNumberDate.append(versionNumber);
      versionNumberDate.append(versionDate);
      versionInfo.append(versionNumberDate);
      
      // Line 2: User name and email
      var versionUser = $('<div/>').addClass('version-user');
      var userNameSpan = $('<span/>')
        .addClass('version-user-name')
        .text(userName);
      versionUser.append(userNameSpan);
      
      if (userEmail) {
        var emailSpan = $('<span/>')
          .addClass('version-user-email')
          .text(' • ' + userEmail);
        versionUser.append(emailSpan);
      }
      versionInfo.append(versionUser);
      
      var versionActions = $('<div/>').addClass('version-actions');
      
      var previewBtn = $('<button/>')
        .addClass('btn-preview')
        .attr('type', 'button')
        .attr('title', 'Preview version')
        .html('<i class="bi bi-eye"></i>')
        .click(function(e) {
          e.stopPropagation();
          var versionIndex = versionsData.findIndex(function(v) { return v.id === version.id; });
          previewVersion(version, versionIndex);
        });
      versionActions.append(previewBtn);
      
      // Add expand/collapse button for collapsed groups
      if (isCollapsed && index === 0) {
        versionCard.addClass('collapsed-group');
        versionCard.attr('data-group-id', 'group-' + groupIndex);
        versionCard.attr('data-group-versions', JSON.stringify(group.versions.map(function(v) { return v.id; })));
        
        var expandBtn = $('<button/>')
          .addClass('btn-expand')
          .attr('type', 'button')
          .attr('title', 'Expand to show all ' + group.versions.length + ' versions')
          .html('<i class="bi bi-chevron-down"></i>')
          .click(function(e) {
            e.stopPropagation();
            expandGroup(versionCard, group);
          });
        versionActions.append(expandBtn);
      }
      
      versionHeader.append(versionInfo);
      versionHeader.append(versionActions);
      
      versionCard.append(versionHeader);
      
      versionCard.click(function() {
        // When collapsed, select the newest version (first in group)
        var versionToSelect = isCollapsed ? group.versions[0] : version;
        toggleVersionSelection(versionToSelect.id, versionToSelect.extension);
      });
      
      // Only add padding when versions cross sides (different domains)
      if (globalIndex > 0 && previousIsBoxDemo !== null && previousIsBoxDemo !== isBoxDemo) {
        // Versions cross sides - add padding to show progression
        versionCard.css('margin-top', '20px');
      }
      
      // Store previous state for next iteration
      previousIsBoxDemo = isBoxDemo;
      
      // Store card info for line drawing (use first version of group for positioning)
      versionCards.push({
        card: versionCard,
        isBoxDemo: isBoxDemo,
        index: globalIndex,
        column: targetColumn,
        group: isCollapsed ? group : null
      });
      
      targetColumn.append(versionCard);
      globalIndex++;
      }); // End of displayVersions loop
    }); // End of versionGroups loop
    
    container.append(timelineWrapper);
    
    // Draw connecting lines after cards are rendered
    setTimeout(function() {
      drawVersionTimelineLines(versionCards);
    }, 200);
  }
  
  function expandGroup(collapsedCard, group) {
    // Create expanded versions
    var expandedCards = [];
    var isBoxDemo = collapsedCard.attr('data-is-boxdemo') === 'true';
    
    // Create cards for all versions in the group (skip first as it's already shown)
    for (var i = 1; i < group.versions.length; i++) {
      var version = group.versions[i];
      
      // Get user info
      var userEmail = '';
      var userName = 'Unknown User';
      if (version.modified_by) {
        userName = version.modified_by.name || 'Unknown User';
        userEmail = version.modified_by.login || '';
      }
      
      // Create version card
      var versionCard = $('<div/>')
        .addClass('version-card')
        .attr('data-version-id', version.id)
        .attr('data-version-ext', version.extension)
        .attr('data-is-boxdemo', isBoxDemo);
      
      var versionHeader = $('<div/>').addClass('version-header');
      var versionInfo = $('<div/>').addClass('version-info');
      
      // Line 1: Version number and date
      var versionNumberDate = $('<div/>').addClass('version-number-date');
      var versionNumber = $('<span/>')
        .addClass('version-number')
        .text('Version ' + version.versionNumber + (version.isCurrent ? ' (Current)' : ''));
      var versionDate = $('<span/>')
        .addClass('version-date')
        .text(formatDate(version.modified_at));
      versionNumberDate.append(versionNumber);
      versionNumberDate.append(versionDate);
      versionInfo.append(versionNumberDate);
      
      // Line 2: User name and email
      var versionUser = $('<div/>').addClass('version-user');
      var userNameSpan = $('<span/>')
        .addClass('version-user-name')
        .text(userName);
      versionUser.append(userNameSpan);
      
      if (userEmail) {
        var emailSpan = $('<span/>')
          .addClass('version-user-email')
          .text(' • ' + userEmail);
        versionUser.append(emailSpan);
      }
      versionInfo.append(versionUser);
      
      var versionActions = $('<div/>').addClass('version-actions');
      
      var previewBtn = $('<button/>')
        .addClass('btn-preview')
        .attr('type', 'button')
        .attr('title', 'Preview version')
        .html('<i class="bi bi-eye"></i>')
        .click(function(e) {
          e.stopPropagation();
          var versionIndex = versionsData.findIndex(function(v) { return v.id === version.id; });
          previewVersion(version, versionIndex);
        });
      versionActions.append(previewBtn);
      
      versionHeader.append(versionInfo);
      versionHeader.append(versionActions);
      versionCard.append(versionHeader);
      
      versionCard.click(function() {
        toggleVersionSelection(version.id, version.extension);
      });
      
      expandedCards.push(versionCard);
    }
    
    // Insert expanded cards after the collapsed card
    $.each(expandedCards, function(idx, card) {
      collapsedCard.after(card);
    });
    
    // Change expand button to collapse button
    var expandBtn = collapsedCard.find('.btn-expand');
    expandBtn.html('<i class="bi bi-chevron-up"></i>')
      .attr('title', 'Collapse group')
      .off('click')
      .click(function(e) {
        e.stopPropagation();
        collapseGroup(collapsedCard, expandedCards, group);
      });
    
    collapsedCard.removeClass('collapsed-group');
    collapsedCard.addClass('expanded-group');
    
    // Update version number to show just the first version
    var versionNumberSpan = collapsedCard.find('.version-number');
    var firstVersion = group.versions[0];
    versionNumberSpan.text('Version ' + firstVersion.versionNumber + (firstVersion.isCurrent ? ' (Current)' : ''));
    
    // Redraw lines
    setTimeout(function() {
      var allCards = [];
      $('.version-card').each(function() {
        var card = $(this);
        allCards.push({
          card: card,
          isBoxDemo: card.attr('data-is-boxdemo') === 'true',
          index: card.index(),
          column: card.parent()
        });
      });
      drawVersionTimelineLines(allCards);
    }, 100);
  }
  
  function collapseGroup(collapsedCard, expandedCards, group) {
    // Remove expanded cards
    $.each(expandedCards, function(idx, card) {
      card.remove();
    });
    
    // Change collapse button back to expand button
    var expandBtn = collapsedCard.find('.btn-expand');
    expandBtn.html('<i class="bi bi-chevron-down"></i>')
      .attr('title', 'Expand to show all ' + group.versions.length + ' versions')
      .off('click')
      .click(function(e) {
        e.stopPropagation();
        expandGroup(collapsedCard, group);
      });
    
    collapsedCard.removeClass('expanded-group');
    collapsedCard.addClass('collapsed-group');
    
    // Update version number to show range
    var firstVersion = group.versions[0];
    var lastVersion = group.versions[group.versions.length - 1];
    var versionNumberSpan = collapsedCard.find('.version-number');
    versionNumberSpan.text('Version ' + firstVersion.versionNumber + ' - ' + lastVersion.versionNumber + 
      ' (' + group.versions.length + ' versions)' + 
      (firstVersion.isCurrent ? ' (Current)' : ''));
    
    // Redraw lines
    setTimeout(function() {
      var allCards = [];
      $('.version-card').each(function() {
        var card = $(this);
        allCards.push({
          card: card,
          isBoxDemo: card.attr('data-is-boxdemo') === 'true',
          index: card.index(),
          column: card.parent()
        });
      });
      drawVersionTimelineLines(allCards);
    }, 100);
  }
  
  function drawVersionTimelineLines(versionCards) {
    // Remove existing line elements
    $('.version-timeline-line-element').remove();
    
    if (versionCards.length < 2) {
      return; // Need at least 2 versions to draw lines
    }
    
    var wrapper = $('.version-timeline-wrapper');
    
    if (wrapper.length === 0) {
      return;
    }
    
    var wrapperWidth = wrapper.width();
    var wrapperOffset = wrapper.offset();
    var centerX = wrapperWidth / 2;
    
    // Draw line to first version card
    if (versionCards.length > 0) {
      var firstCard = versionCards[0].card;
      var firstCardOffset = firstCard.offset();
      if (firstCardOffset && wrapperOffset) {
        var firstTop = (firstCardOffset.top - wrapperOffset.top) + firstCard.outerHeight() / 2;
        var firstX;
        if (versionCards[0].isBoxDemo) {
          firstX = (firstCardOffset.left - wrapperOffset.left) + firstCard.outerWidth();
        } else {
          firstX = firstCardOffset.left - wrapperOffset.left;
        }
        
        var firstHorizontal = $('<div/>')
          .addClass('version-timeline-line-element horizontal crossing')
          .css({
            'left': Math.min(centerX, firstX) + 'px',
            'top': (firstTop - 1) + 'px',
            'width': Math.abs(centerX - firstX) + 'px'
          });
        wrapper.append(firstHorizontal);
      }
    }
    
    // Draw lines connecting consecutive versions (22->21->20->19 etc.)
    for (var i = 0; i < versionCards.length - 1; i++) {
      var current = versionCards[i];
      var next = versionCards[i + 1];
      
      var currentCard = current.card;
      var nextCard = next.card;
      
      if (currentCard.length && nextCard.length) {
        // Get positions relative to document
        var currentCardOffset = currentCard.offset();
        var nextCardOffset = nextCard.offset();
        
        if (!currentCardOffset || !nextCardOffset || !wrapperOffset) {
          continue;
        }
        
        // Calculate positions relative to wrapper
        var currentTop = (currentCardOffset.top - wrapperOffset.top) + currentCard.outerHeight() / 2;
        var nextTop = (nextCardOffset.top - wrapperOffset.top) + nextCard.outerHeight() / 2;
        
        // Calculate start and end X positions relative to wrapper
        var startX, endX;
        
        if (current.isBoxDemo) {
          // Left side - line starts from right edge of card
          startX = (currentCardOffset.left - wrapperOffset.left) + currentCard.outerWidth();
        } else {
          // Right side - line starts from left edge of card
          startX = currentCardOffset.left - wrapperOffset.left;
        }
        
        if (next.isBoxDemo) {
          // Left side - line ends at right edge of card
          endX = (nextCardOffset.left - wrapperOffset.left) + nextCard.outerWidth();
        } else {
          // Right side - line ends at left edge of card
          endX = nextCardOffset.left - wrapperOffset.left;
        }
        
        // Always draw red lines connecting versions
        // Draw vertical line connecting consecutive versions down the center
        var verticalLine = $('<div/>')
          .addClass('version-timeline-line-element vertical crossing')
          .css({
            'left': (centerX - 1) + 'px',
            'top': currentTop + 'px',
            'height': (nextTop - currentTop) + 'px'
          });
        wrapper.append(verticalLine);
        
        // Draw horizontal line from center to current card
        var horizontalFromCurrent = $('<div/>')
          .addClass('version-timeline-line-element horizontal crossing')
          .css({
            'left': Math.min(centerX, startX) + 'px',
            'top': (currentTop - 1) + 'px',
            'width': Math.abs(centerX - startX) + 'px'
          });
        wrapper.append(horizontalFromCurrent);
        
        // Draw horizontal line from center to next card
        var horizontalToNext = $('<div/>')
          .addClass('version-timeline-line-element horizontal crossing')
          .css({
            'left': Math.min(centerX, endX) + 'px',
            'top': (nextTop - 1) + 'px',
            'width': Math.abs(centerX - endX) + 'px'
          });
        wrapper.append(horizontalToNext);
      }
    }
  }
  
  function toggleVersionSelection(versionId, extension) {
    var index = selectedVersions.findIndex(function(v) { return v.id === versionId; });
    
    // Find the version data to get version number
    var versionData = versionsData.find(function(v) { return v.id === versionId; });
    var versionNumber = versionData ? versionData.versionNumber : null;
    
    if (index >= 0) {
      // Deselect
      selectedVersions.splice(index, 1);
      $('.version-card[data-version-id="' + versionId + '"]').removeClass('selected');
    } else {
      // Select (with circular selection logic)
      if (selectedVersions.length >= 2) {
        // Remove first selection
        var firstId = selectedVersions[0].id;
        $('.version-card[data-version-id="' + firstId + '"]').removeClass('selected');
        selectedVersions.shift();
      }
      
      // Add new selection with version number
      selectedVersions.push({ id: versionId, ext: extension, versionNumber: versionNumber });
      $('.version-card[data-version-id="' + versionId + '"]').addClass('selected');
    }
    
    updateCompareButton();
    updateSelectionBadges();
    updateHeaderWithComparison();
  }
  
  function updateSelectionBadges() {
    $('.version-card').each(function() {
      var versionId = $(this).attr('data-version-id');
      var index = selectedVersions.findIndex(function(v) { return v.id === versionId; });
      
      $(this).find('.selection-badge').remove();
      
      if (index >= 0) {
        var badge = $('<span/>')
          .addClass('selection-badge')
          .text(index + 1);
        $(this).find('.version-number').prepend(badge);
      }
     });
   }
  
  function updateCompareButton() {
    var btn = $('.btn-compare');
    if (selectedVersions.length === 2) {
      btn.prop('disabled', false);
    } else {
      btn.prop('disabled', true);
    }
  }
  
  function updateHeaderWithComparison() {
    var fileNameDisplay = $("#fileNameDisplay");
    var fileName = fileNameDisplay.data('original-name') || fileNameDisplay.text();
    
    // Store original name if not already stored
    if (!fileNameDisplay.data('original-name')) {
      fileNameDisplay.data('original-name', fileName);
    }
    
    // Check if collapsed
    var isCollapsed = !$('#versionSelectorCollapse').hasClass('show');
    
    if (isCollapsed && selectedVersions.length === 2) {
      // Show comparison info when collapsed
      var v1 = selectedVersions[0].versionNumber || '?';
      var v2 = selectedVersions[1].versionNumber || '?';
      fileNameDisplay.text(fileName + ' - Comparing Version ' + v1 + ' vs Version ' + v2);
    } else {
      // Show just the file name when expanded or no comparison
      fileNameDisplay.text(fileName);
    }
  }
  
  function previewVersion(version, versionIndex) {
    $('#previewModalLabel').text('Preview: ' + (version.name || 'Version ' + version.versionNumber));
    
    // Wait for Box Preview library to load
    
    
    initializeBoxPreview(version, versionIndex);
  }
  
  function initializeBoxPreview(version, versionIndex) {
    try {
      // Store current version index
      if (versionIndex !== undefined) {
        currentPreviewVersionIndex = versionIndex;
      } else {
        // Find index if not provided
        currentPreviewVersionIndex = versionsData.findIndex(function(v) { return v.id === version.id; });
      }
      
      // Clean up previous preview instance
      if (boxPreviewInstance) {
        try {
          boxPreviewInstance.hide();
        } catch (e) {
          console.log("**Error hiding previous preview:** " + e.message);
        }
        boxPreviewInstance = null;
      }
      
      // Clear the preview container
      $('#boxPreviewContainer').empty();
      
      // Show the modal first
      var previewModalElement = document.getElementById('previewModal');
      var previewModal = new bootstrap.Modal(previewModalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
      previewModal.show();
      
      // Ensure backdrop is clickable to close
      $(previewModalElement).on('click', function(e) {
        if (e.target === previewModalElement) {
          previewModal.hide();
        }
      });
      
      // Add navigation buttons if multiple versions
      if (versionsData.length > 1) {
        addVersionNavigationButtons();
      }
      
      // Prepare file options for version-specific preview
      var fileOptions = {};
      
      if (version.isCurrent) {
        // For current version, use file ID directly
        // No special fileOptions needed
      } else {
        // For older versions, specify the version ID
        fileOptions[fileId] = {
          fileVersionId: version.id,
          currentFileVersionId: currentFileVersionId
        };
      }
      
      // Create new preview instance
      boxPreviewInstance = new Box.ContentPreview();
      
      // Show preview with version-specific options
      boxPreviewInstance.show(fileId, accessToken, {
        container: '#boxPreviewContainer',
        hasHeader: true,
        showDownload: true,
        showAnnotations: true,
        fileOptions: Object.keys(fileOptions).length > 0 ? fileOptions : undefined
      });
      
      // Update version indicator
      updateVersionIndicator(version);
      
      console.log("**Box Preview initialized for version:** " + version.versionNumber + 
        (version.isCurrent ? " (current)" : " (version ID: " + version.id + ")"));
      
    } catch (error) {
      console.log("**Error initializing Box Preview:** " + JSON.stringify(error));
      alert('Unable to load preview. The file may not support preview or there was an error accessing it.');
    }
  }
  
  function addVersionNavigationButtons() {
    // Remove existing buttons if any
    $('.preview-nav-buttons').remove();
    $('.preview-version-indicator').remove();
    
    // Add previous button
    var prevBtn = $('<button/>')
      .addClass('btn-nav preview-nav-buttons prev')
      .attr('type', 'button')
      .html('<i class="bi bi-chevron-left"></i>')
      .click(function() {
        navigateToVersion(-1);
      });
    
    // Add next button
    var nextBtn = $('<button/>')
      .addClass('btn-nav preview-nav-buttons next')
      .attr('type', 'button')
      .html('<i class="bi bi-chevron-right"></i>')
      .click(function() {
        navigateToVersion(1);
      });
    
    $('.preview-modal .modal-body').append(prevBtn);
    $('.preview-modal .modal-body').append(nextBtn);
    
    updateNavigationButtons();
  }
  
  function updateNavigationButtons() {
    var prevBtn = $('.preview-nav-buttons.prev');
    var nextBtn = $('.preview-nav-buttons.next');
    
    // Disable prev if at first version
    prevBtn.prop('disabled', currentPreviewVersionIndex <= 0);
    
    // Disable next if at last version
    nextBtn.prop('disabled', currentPreviewVersionIndex >= versionsData.length - 1);
  }
  
  function updateVersionIndicator(version) {
    // Remove existing indicator
    $('.preview-version-indicator').remove();
    
    // Add version indicator
    var indicator = $('<div/>')
      .addClass('preview-version-indicator')
      .text('Version ' + version.versionNumber + (version.isCurrent ? ' (Current)' : '') + 
            ' (' + (currentPreviewVersionIndex + 1) + ' of ' + versionsData.length + ')');
    
    $('.preview-modal .modal-body').append(indicator);
  }
  
  function navigateToVersion(direction) {
    var newIndex = currentPreviewVersionIndex + direction;
    
    if (newIndex < 0 || newIndex >= versionsData.length) {
      return;
    }
    
    var newVersion = versionsData[newIndex];
    if (newVersion) {
      initializeBoxPreview(newVersion, newIndex);
    }
  }
  
  // Clean up preview when modal is closed
  $(document).on('hidden.bs.modal', '#previewModal', function() {
    if (boxPreviewInstance) {
      try {
        boxPreviewInstance.hide();
      } catch (e) {
        console.log("**Error cleaning up preview:** " + e.message);
      }
      boxPreviewInstance = null;
      $('#boxPreviewContainer').empty();
    }
    
    // Remove navigation buttons and indicator
    $('.preview-nav-buttons').remove();
    $('.preview-version-indicator').remove();
    currentPreviewVersionIndex = -1;
    
    // Ensure backdrop is removed
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open');
    $('body').css('padding-right', '');
    $('body').css('overflow', '');
  });
  
  // Keyboard navigation for versions
  $(document).on('keydown', function(e) {
    if ($('#previewModal').hasClass('show') && versionsData.length > 1) {
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        navigateToVersion(-1);
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        navigateToVersion(1);
      }
    }
  });
  
  // Also handle ESC key to close modal
  $(document).on('keydown', function(e) {
    if (e.key === 'Escape' && $('#previewModal').hasClass('show')) {
      var previewModal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
      if (previewModal) {
        previewModal.hide();
      }
    }
  });
  
  function compare() {
    if (selectedVersions.length !== 2) {
      return;
    }
    
    var id1 = selectedVersions[0].id;
    var id2 = selectedVersions[1].id;
    var ext1 = selectedVersions[0].ext;
    var ext2 = selectedVersions[1].ext;
    
    $('#compareFrame').attr('src', '');
    $('#loader').show();
    $('.comparison-viewer').hide();
    
    var url = 'https://cvw2zdcqpc.execute-api.eu-west-2.amazonaws.com/default/box-document-compare?mainId=' + fileId + '&id1=' + id1 + '&id2=' + id2 + '&token=' + accessToken + '&ext1=' + ext1 + '&ext2=' + ext2;
    console.log("**Compare URL:** " + url);
    
     $.ajax({
       url: url,
       headers: {},
       type: 'get',
      data: {},
       success: function(response) {
         $("#loader").hide();
        var src = response.url;
        $('.comparison-viewer').show();
        $('#compareFrame').attr('src', src);
        
        // Auto-collapse version selector when comparison loads
        var collapseElement = document.getElementById('versionSelectorCollapse');
        if (collapseElement) {
          var bsCollapse = bootstrap.Collapse.getInstance(collapseElement);
          if (!bsCollapse) {
            bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
          }
          bsCollapse.hide();
          
          // Update header after collapse animation completes
          setTimeout(function() {
            updateHeaderWithComparison();
          }, 350);
        }
       },
       error: function(xhr) {
         $("#loader").hide();
        $('.comparison-viewer').show();
        $('.comparison-viewer').html('<div class="alert alert-danger">An error occurred processing the comparison. Please try again.</div>');
       }
     });
   }

  // Initialize compare button
  $(document).on('click', '.btn-compare', function() {
    compare();
  });
  
  // Update header when collapse state changes
  $('#versionSelectorCollapse').on('shown.bs.collapse hidden.bs.collapse', function() {
    updateHeaderWithComparison();
  });
  
  // Handle time filter dropdown change
  $(document).on('change', '#timeFilterSelect', function() {
    timeFilterDays = parseInt($(this).val(), 10);
    applyTimeFilter();
  });
</script>

</head>
<body>
  <div class="main-container">
    <div class="version-selector-panel">
      <div class="file-name-header" data-bs-toggle="collapse" data-bs-target="#versionSelectorCollapse" aria-expanded="true" aria-controls="versionSelectorCollapse">
        <span id="fileNameDisplay">Loading...</span>
        <i class="bi bi-chevron-down toggle-icon"></i>
      </div>
      
      <div class="collapse show version-selector-collapse" id="versionSelectorCollapse">
        <div class="time-filter-selector">
          <label for="timeFilterSelect">Show versions:</label>
          <select id="timeFilterSelect" class="form-select form-select-sm">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="0">All versions</option>
          </select>
            </div>
        <div class="version-list-container">
          <!-- Versions will be rendered here -->
        </div>
        
        <div class="compare-button-container">
          <button class="btn btn-primary btn-compare" disabled>
            <i class="bi bi-arrow-left-right"></i> Compare Selected Versions
          </button>
          <small class="text-muted d-block mt-2">Select exactly 2 versions to compare</small>
          </div>
        </div>
    </div>
    
    <div class="comparison-viewer">
      <iframe id="compareFrame" src=""></iframe>
            </div>
        </div>

  <!-- Preview Modal -->
  <div class="modal fade preview-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-body">
          <div id="boxPreviewContainer" class="box-preview-container"></div>
          <button type="button" class="btn btn-sm btn-secondary btn-close-modal" data-bs-dismiss="modal" aria-label="Close">
            <i class="bi bi-x-lg"></i>
          </button>
          </div>
        </div>
    </div>
</div>

  <div id='loader'>
    <div class="spinner"></div>
  </div>
</body>
</html>
