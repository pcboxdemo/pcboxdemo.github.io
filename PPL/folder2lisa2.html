<!DOCTYPE html>
<html lang="en-US">
<meta charset="utf-8" />
<meta http-equiv="Cache-control" content="No-Cache">
<title>Box Platform - Template Application</title>
<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <title>Box Content Preview Demo</title>
  <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>

  <!-- polyfill.io only loads the polyfills your browser needs -->
  <script src="https://cdn01.boxcdn.net/polyfills/core-js/2.5.3/core.min.js"></script>
  <script src="config.json"></script>
  <script src="js/box.js"></script>
  <!-- Latest version of the explorer css for your locale -->
  <link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/12.0.0/en-US/explorer.css" />
  <script src="https://cdn01.boxcdn.net/platform/elements/12.0.0/en-US/explorer.js"></script>
  <script src="https://cdn01.boxcdn.net/platform/preview/2.26.0/en-US/preview.js"></script>
  <style>
    .bce-more-options {
      display: none;
    }

    .bce-btn-more-options {
      display: none;
    }

    .DraftEditor-editorContainer {
      width: 250px;
      height: 36px;
    }

    /* The Modal (background) */
    .modal {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /*Sit on top */
      padding-top: 50px;
      /* Location of the box */
      left: 0;
      top: 0;
      width: 90%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
      position: relative;
      background-color: #ffffff;
      margin: auto;
      height: 90vw;
      padding: 0;
      border: 1px solid #888;
      width: 100%;
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
      -webkit-animation-name: animatetop;
      -webkit-animation-duration: 0.4s;
      animation-name: animatetop;
      animation-duration: 0.4s
    }

    /* Add Animation */
    @-webkit-keyframes animatetop {
      from {
        top: -300px;
        opacity: 0
      }

      to {
        top: 0;
        opacity: 1
      }
    }

    @keyframes animatetop {
      from {
        top: -300px;
        opacity: 0
      }

      to {
        top: 0;
        opacity: 1
      }
    }

    /* The Close Button */
    .close {
      color: black;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .modal-header {
      padding: 2px 8px;
      background-color: #ffffff;
      color: white;
    }

    .modal-body {
      padding: 2px 8px;
      position: static;
    }

    .modal-footer {
      padding: 2px 16px;
      background-color: #5cb85c;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container" style="height:90vh; width:100vw;"></div>
  <script>
    var pageData = getPageData();
    var contentExplorer = new Box.ContentExplorer();
    //get folder id
    let searchParams = new URLSearchParams(window.location.search)
    var boxId = "144789876683";//pageData.boxId
    var currentFolderId = searchParams.get("currentFolderId");
    //load explorer with token
    var contentExplorer = new Box.ContentExplorer();
    var showVideoButton=false;
    var objType;
    var currentSelected;
    getAccessToken().then(function (result) {
      $.ajax({
        url: "https://api.box.com/oauth2/token",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        type: 'post',
        data: {
          "subject_token": result,
          "subject_token_type": "urn:ietf:params:oauth:token-type:access_token",
          "scope": "base_explorer annotation_view_all item_share item_download base_upload",
          "resource": "https://api.box.com/2.0/folders/" + boxId,
          "grant_type": "urn:ietf:params:oauth:grant-type:token-exchange"
        },
        success: function (response1) {
          console.log("accessToken:" + response1.access_token);
          contentExplorer.show(boxId, response1.access_token, {
            logoUrl: 'img/custom/logo-small.png',
            container: '.container',
            currentFolderId: currentFolderId,
            rootFolderId: boxId,
            showAnnotations: 'true',
            contentPreviewProps: {
              showAnnotations: true

            }
          });
          contentExplorer.addListener('select', (item) => {
            selectedFolder = item[0].id;
            sessionStorage.setItem('selectedId', selectedFolder);
            var extension = item[0].name.substr((item[0].name.lastIndexOf('.') + 1));
            sessionStorage.setItem('selectedExt', extension);

            //if video file, show transcode button
            console.log("Showing cops?");

           
              var name = item[0].name;
              if (name.endsWith('docx') || name.endsWith('pdf')) {
                fixButton();
                objType = 'Compare';
                showVideoButton = true;
                hackDom('Compare');

              }
            
            console.log(item[0].type);


          });

          contentExplorer.addListener('navigate', (item) => {
            showVideoButton = false;
            console.log("Item:" + item.id + "=" + folderId);
            if (item.id == folderId) {
             // console.log(item.id + "=" + folderId + " setting to true");
             // showCopsButton = true;
            }
            else {
              console.log(item.id + "!=" + folderId + " setting to false");
              showCopsButton = false;
              console.log("hiding currentSelected");
              currentSelected.style.display = 'none';

            }
          });



        },
        error: function (xhr, status, error) {
          console.log(JSON.stringify(xhr));
          console.log("error:" + xhr.responseText);

        }
      });

    });
    function hackDom(objType) {
      //hack dom
      var allSpans = document.getElementsByTagName('span');
      var i = 0;
      console.log("found " + allSpans.length);
      for (i = 0; i < allSpans.length; i++) {
        var obj = allSpans[i];
        console.log(obj.innerHTML);
        if (obj.innerHTML == 'Share' || obj.innerHTML == 'COPFS' || obj.innerHTML == 'COMPARE') {
          obj.innerHTML = objType;
          obj.parentNode.parentNode.onclick = function (event) { changeEvent(event); };
          obj.parentNode.onclick = function (event) { changeEvent(event); };
          obj.onclick = function (event) { changeEvent(event); };
          currentSpan = obj;
        }
      }
    }
    function changeEvent(ev) {
      console.log(ev);
      if (objType == 'Compare') {
        document.getElementById('myframe').src = 'compare.html?id=' + sessionStorage.getItem('selectedId') + '&ext='+sessionStorage.getItem('selectedExt');
        document.getElementById('myframe').src = 'compare.html?id=' + sessionStorage.getItem('selectedId') + '&ext='+sessionStorage.getItem('selectedExt');
        document.getElementById('myModal').style.display = "block";
        contentExplorer.clearCache();

      }

      ev.cancelBubble = true;
    }
    function fixButton() {
      var divs = document.getElementsByTagName('div');
      console.log("fixign button");
      for (i = 0; i < divs.length; i++) {
        if (divs[i].className == 'bce-more-options' && divs[i].parentNode.parentNode.className.includes('bce-item-row-selected')) {
          console.log("displaying more options:" + divs[i].innerHTML);
          divs[i].style.display = 'block';
          if (currentSelected && currentSelected != divs[i]) {
            console.log("hiding currentSelected:" + currentSelected.innerHTML);
            currentSelected.style.display = 'none';
          }
          currentSelected = divs[i];
        }
      }
    };
    function closeModal() {
      document.getElementById('myModal').style.display = "none";
      document.getElementById('myframe').src = 'blank.html';
      contentExplorer.clearCache();
    }
  </script>

<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
      <span class="close" onclick="closeModal();">&times;</span>
    </div>
    <div class="modal-body">
      <iframe id='myframe' src="blank.html" width="100%" height="700px" frameborder="0"></iframe>
    </div>

  </div>

</div>
</body>
</head>

</html>