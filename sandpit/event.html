<!doctype html>
<html lang="en">

<head>


	<html>

	<head>
		<script src="https://unpkg.com/ag-grid-enterprise/dist/ag-grid-enterprise.min.noStyle.js"></script>
		<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
		<link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-balham.css">

		<script>
			var clientId = "bn2iyg37p78jkowrp0io0nc2ln0be3wt";

		</script>

	</head>

	<body>
			
		<div id="myGrid" style='width:100%;display:block;height:100vh' class="ag-theme-balham"></div>

		<script type="text/javascript" charset="utf-8">
			// specify the columns
			var nextStream = null;
			var columnDefs = [
				{ headerName: "Event Type", field: "event_type", "suppressSizeToFit": true },
				{ headerName: "Created By", field: "created_by.name", "suppressSizeToFit": true },
				{ headerName: "Created At", field: "created_at", "suppressSizeToFit": true },
				{ headerName: "Item Type", field: "source.item_type", "suppressSizeToFit": true },
				{ headerName: "Item Name", field: "source.item_name" }
			];

			// let the grid know which columns and what data to use
			var gridOptions = {
				columnDefs: columnDefs,
				groupSelectsChildren: true,
				rowSelection: 'multiple',
				rowModelType: 'serverSide'
			};
			var keepGoing = true;
			var server = createServer();
			var rows;
			function createServer() {
				return {
					// called by the grid when more rows are required
					getData: async function (request) {
						var boxresponse;
						console.log(JSON.stringify(request, null, 1));
						await fetch('https://api.box.com/2.0/events?limit=100&created_after=2020-12-01T22:02:24-07:00&stream_type=admin_logs' + (nextStream == null ? "" : "&stream_position=" + nextStream), {
							method: 'get',
							headers: { 'Authorization': 'Bearer EVSQlbe3qr32vLS6oUXWELt89T3WLfS9' }
							})
							.then(httpResponse => httpResponse.json())
							.then(response => {
								boxresponse=response;
								nextStream = response.next_stream_position;
								console.log(response.chunk_size);
								rows+=response.chunk_size;
								return {
									success: response.chunk_size != 0,
									rows: response.entries,
									lastRow: response.chunk_size
								}
							})
							.catch(error => {
								console.error(error);
								params.failCallback();
							})
							return {
									success: boxresponse.chunk_size==0?false:true,
									rows: boxresponse.entries,
									lastRow: boxresponse.chunk_size==0?rows:undefined
								}	
					}

				};
			}

			function createDatasource(server) {
				return {
					getRows: async function (params) {
						console.log('[Datasource] - rows requested by grid: ', params.request);

						// get data for request from our fake server
						var response = await server.getData(params.request);
						console.log("R:"+response)
						// simulating real server call with a 500ms delay
						setTimeout(function () {
							if (response.success) {
								// supply rows for requested block to grid
								params.successCallback(response.rows, response.lastRow);
							} else {
								params.failCallback();
							}
						}, 500);
					},
				};
			}
			var myDatasource = createDatasource(server);
			// lookup the container we want the Grid to use
			var eGridDiv = document.querySelector('#myGrid');

			// create the grid passing in the div to use together with the columns & data we want to use
			new agGrid.Grid(eGridDiv, gridOptions);
			gridOptions.api.setServerSideDatasource(myDatasource);
		</script>
	</body>

	</html>