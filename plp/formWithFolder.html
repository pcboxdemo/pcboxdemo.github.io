<!DOCTYPE html>
<html>


<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" type="text/css" media="screen"
  href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

<!-- Box preview SDK -->
<link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/9.1.1/en-US/uploader.css">
<script src="https://cdn01.boxcdn.net/platform/elements/9.1.0/en-US/uploader.js"></script>
<script type="text/javascript" src="config.json"></script>
<script type="text/javascript" src="js/box.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  input[type=text],
  select {
    width: 100%;
    padding: 12px 20px;
    margin: 8px 0;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }

  input[type=submit] {
    width: 100%;
    background-color: #0161d4;
    color: white;
    padding: 14px 20px;
    margin: 8px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  p {
    font-family: Roboto, sans-serif;
    font-size: 18px;
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;

    text-align: left;
  }

  label,
  select,
  input,
  option {
    font-family: Roboto, sans-serif;
    font-size: 14px;
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;



  }



  .bcu-footer {
    display: none;
  }
</style>

<script>
  var accessToken;
  var pageData = getPageData();
  var boxId = pageData.boxId;
  var eid = pageData.eid;
  var templateKey = pageData.templateKey;
  var contentUploader = new Box.ContentUploader();
  var fields = [];
  var newFolderId;
  $(document).ready(function () {
    $(document).ready(function () {
      $('.js-example-basic-single').select2();
    });
    $("#loader").hide();

    var changeId = (config) => {
      console.log(config.method);
      if (config.method == 'post') {
        var tempAttr = JSON.parse(config.data.attributes);
        console.log("Parent " + newFolderId);
        tempAttr.parent.id = newFolderId;
        config.data.attributes = JSON.stringify(tempAttr);
      }
      return config;
    };
    $('body').on('focus', ".datepicker", function () {
      $(this).datepicker({
        "dateFormat": "yy-mm-dd"
      });
      //  $(this).datetimepicker();
    });
    $("#uploadfiles").on('submit', function (ev) {
      ev.preventDefault();
      $("#loader").show();
      $("#submit").hide();
      createFolder().then(function (result) {
        console.log("Created folder:" + result);

        
      });
    });
    getAccessToken().then(function (result) {
      accessToken = result;

      contentUploader.show(boxId, result, {
        container: '.pcontainer',
        requestInterceptor: changeId

      });
    });
    contentUploader.addListener('onBeforeUpload', function (file) {
      console.log("Before upload");
      console.log(file);
    });
    contentUploader.addListener('OnInteraction', function (file) {
      console.log("interaction");
    });
    contentUploader.addListener('complete', function (file) {
      console.log("complete:" + JSON.stringify(file));
      var counter = 0;
      var target = file.length;
      console.log(target);
      $(".mainer").hide();
      $("#okmessage").show().fadeOut(3000, function(){window.location.href = "folder2.html?currentFolderId=" + newFolderId +"&title=ALL CONTRACTS";});


    });
  });
  async function createFolder() {
    var newFolderName = $("#folderName").val();
    var data = '{"name":"' + newFolderName + '","parent":{"id":"' + boxId + '"}}';
    var settings = {
      "async": true,
      "crossDomain": true,
      "url": "https://api.box.com/2.0/folders",
      "method": "POST",
      "headers": {
        "Authorization": "Bearer " + accessToken,
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      },
      "processData": false,
      "data": data
    };

    $.ajax(settings).done(function (response) {
      newFolderId = response.id;
      $(".btn-primary").trigger("click");
      console.log("show message");
      
      console.log("message shown");
      return newFolderId;

    });

  }
</script>

<body>
  <div class="container" style="height:90vh; width:100vw;">


    <div style="width: 100%; overflow: hidden;z-index:-9999;" id="main">
      <span id="okmessage" style="display:none">Contract succesfully created</span>
      <br>
      <div style="width: 600px; float: left;margin-left:50px;z-index:-9999;" class="mainer">

        <P>New contract</P>
        Name:
        <input type="text" id="folderName" />
        Underwriters:
        <select class="js-example-basic-single" name="collab" multiple="multiple">
          <option value="xx">James the Underwriter</option>
          <option value="yy">Matt the Underwriter</option>
          <option value="zz">Peter the Underwriter</option>
          <option value="cc">Sam the Underwriter</option>
        </select>
        <br>
        <br>
        <form id="uploadfiles" action="#" method="get">
          <input type="submit" id="submit" value="Upload to Box">
          <img id="loader" src="img/custom/ajax-loader_transparent.gif">

        </form>
      </div>
      <div style="margin-left: 670px;z-index:9999;" class="pcontainer">
      </div>
    </div>
  </div>
</body>

</html>