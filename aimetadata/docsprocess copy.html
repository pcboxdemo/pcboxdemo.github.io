<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box AI Document Categorization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Box AI Document Categorization</h2>
        <div class="mb-3">
            
            <select id="aiAgentSelector" class="form-select d-inline-block w-auto mx-2 actions"></select>
            <select id="batchSizeSelector" class="form-select d-inline-block w-auto actions">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="25">25</option>
            </select>
            <button id="loadDataBtn" class="btn btn-primary actions">Load Data</button>
            <button id="startProcessingBtn" class="btn btn-success actions">Start Processing</button>
            <img src="ajax-loader (3).gif" style="display: none;" class="loader"/>
            <span class="loader">Initializing folders</span>

            <span class="badge rounded-pill bg-primary actions " id="dfound">Documents found:0</span>
            <span class="badge rounded-pill bg-primary actions " id="dproc">Documents processed:0</span>

            <span class="badge rounded-pill bg-primary actions " id="dqueue">Queue size: 0</span>
            <span class="badge rounded-pill bg-primary actions " id="drunning">Running calls: 0</span>

        </div>
        <table id="documentTable" class="table table-striped">
            <thead>
                <tr>
                    
                    
                    <th>Category</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
        const folderQueue = []; // Queue for folder creation requests
        const MAX_CONCURRENT_FOLDER_CREATION = 1; // Limit concurrent folder creations
        let activeFolderCreations = 0;
        let categoryToFolderPath = {};
        let categoryToFolderId = {};
        let moveQueue = [];
        let runningMoves = 0;
        let maxConcurrentMoves = 10;
        let rootFolderId = '309905769114';
        let rootTargetFolder = '310616733181';
        let boxToken = '1!8ZVcmWT1s6qpznT1YVJ0wU5XfVM67wk1ATQSSdPRJ4mpqCYr3yd_csDQextibNgVeBoA8ZEApmAYHkf2cTpLJMTJu9tA_FoPPJUbdoAmI9sNrB2qVXh0ZJcIsOwP9LBwZRZFL4CLjEPENxAL2eMXiRj_U9jPSdd_BXqQJ1pcJSFTTCWXuvIN6MK_3h_EearHkr2OKb21QNXaAdDijy-AsZIpQ6OFjazZWzRY40N34xr-CWzcfTHDIt0CfHmJ09q6SPgpGki7D_d_JYxKaEio2dCaUyzQgX5FnfQiSdYgFOd7N0YRev17EwT-KRya7FyQm5X1FD7D2tlD1wpFnHYJS_Ku_Y2Kod7cObp_EXVWDQ00t9bZMvgmaVsP0SB0AjWy12wE01n8s5oUuD1j4YItGStrtXQ8ZnTy_wwu7QcI_Pi6IAVljhSXtOOg4zY3rrPaChr2y1iFwoR1SzyB2rS2QP4Nbj4d_ChPoCydfeVWo5iyviYMgO_F0pd5wG3EuHnV96JXmlXx90e4ugVBt2qg1ocnoWI8dqUNZ45HtefX16D2Jx6V40pbGaYms8FIqrCqxlq69-5mM_uT59yf-aN6skt0P9qkv7AMJS3BsBvZLG4-itHRh4ftBazQNlyPYWmtmp08xLNR5MLKbWKJd0O8B3tzTIG8-yjpB8fdMnBYO3yLbkTP6syECw5VDT5WciZkDBRPL4RJXHX2iLEjYATT_Sc10aUMrAEifDMejOs8V1mK4gvkEvXhwnCulaKjARSGYwG9Zd6oKP-rjnEFQudOebeCg3VpaHOLcySxk2Glm-vu3MVMWNY3IZzR796bHcq68Shj1fo6bopAre3m6gAk0MPS6f097zwHN79JcbgSybqUzzl--NiJw_vbMTXWkmnQCZMVFMyXq1_sQYUS';
         let table ;
         let fileIdMapping = [];
         let fileProcessedCounter=0,fileFoundCounter=0;
         let apiQueue = [];
         let runningCalls = 0;

        $(document).ready(function() {
            
            table = $('#documentTable').DataTable({
                paging: true,
                pageLength: 200,
                searching: true,
                ordering: true,
            });
            
            let maxConcurrentCalls = 5;
            let selectedAgentId = null;
            let batchSize = 1;

            let globalPrompt = "Categorize these documents";
            
            $('#loadDataBtn').click(function() {
                //table.clear().draw();
                fetchDocuments(rootFolderId);
            });
            function fetchAgents() {
                $.ajax({
                    url: "https://api.box.com/2.0/ai_agents",
                    headers: { Authorization: `Bearer ${boxToken}` },
                    success: function(response) {
                        response.entries.forEach(agent => {
                            $('#aiAgentSelector').append(new Option(agent.name, agent.id));
                        });
                        selectedAgentId = $('#aiAgentSelector').val();
                    }
                });
            }

            $('#aiAgentSelector').change(function() {
                selectedAgentId = $(this).val();
            });

            $('#batchSizeSelector').change(function() {
                batchSize = parseInt($(this).val());
            });
            let batch = [];
            
            function fetchDocuments(folderId) {
                $.ajax({
                    url: `https://api.box.com/2.0/folders/${folderId}/items`,
                    headers: { Authorization: `Bearer ${boxToken}` },
                    success: function(response) {
                        response.entries.forEach(file => {
                            if (file.type === 'file') {
                                fileIdMapping.push({name:file.name,id:file.id});
                                fileFoundCounter++;
                                batch.push(file);
                                updateFoundStats();
                                if (batch.length === batchSize) {
                                    apiQueue.push(batch);
                                    batch = [];
                                }
                                //table.row.add([file.id,file.name, "Pending", "Pending"]).draw();

                            }
                            else {
                                fetchDocuments(file.id);
                            }
                        });
                        if (batch.length > 0) apiQueue.push(batch);
                    }
                });
            }

            function processQueue() {
                if (runningCalls >= maxConcurrentCalls || apiQueue.length === 0) {
                    return;
                }
            
                let files = apiQueue.shift();
                runningCalls++;
                updateQueueStats();
                updateCallsStats();
                callBoxAI(files).then(() => {
                    runningCalls--;
                    updateCallsStats();
                    processQueue(); // Recursively continue processing
                }).catch(() => {
                    runningCalls--;
                    updateCallsStats();
                    processQueue(); // Retry failed requests
                });
            }
            
            // Use `setInterval` to continuously process the queue
            setInterval(() => {
                processQueue();
            }, 500); // Check the queue every 500ms
            

            async function callBoxAI(files) {
                let mode = files.length === 1 ? "multiple_item_qa" : "multiple_item_qa";
                let data = {
                    "prompt": appendNamesAndCountToPrompt(files),
                    "ai_agent": { "id": selectedAgentId, "type": "ai_agent_id" },
                    "mode": mode,
                    "items": files.map(f => ({ "type": "file", "id": f.id }))
                };
            
                let startTime = performance.now();
            
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: "https://api.box.com/2.0/ai/ask",
                        headers: { Authorization: `Bearer ${boxToken}`, "Content-Type": "application/json" },
                        method: 'POST',
                        data: JSON.stringify(data),
                        success: function(response) {
                            let endTime = performance.now();
                            let executionTime = ((endTime - startTime) / 1000).toFixed(1);
                            
                            let goodAnswer = parseJsonFromString(response.answer);
                            let answers = Array.isArray(goodAnswer) ? goodAnswer : [goodAnswer];
            
                            fileProcessedCounter += files.length; // Update processed count
                            updateProcStats();
            
                            answers.forEach(answer => {
                                let result = fileIdMapping.find(item => item.name === answer.fileName);
                                if (result) {
                                    //queueFileMove(result.id, answer.category);
                                    //try copy here?
                                    //copyDocument(result.id, answer.category);
                                }
            
                                table.rows().every(function() {
                                    let rowData = this.data();
                                    if (rowData[0] === answer.category) {
                                        let count = parseInt(rowData[1]) + 1;
                                        this.data([rowData[0], count]).draw();
                                    }
                                });
                            });
            
                            resolve(); // Ensure processQueue() is called again after success
                        },
                        error: function(err) {
                            console.error("AI Processing Error:", err);
                            reject(err);
                        },
                        complete: function() {
                            runningCalls--;
                            processQueue(); // Continue processing even on failure
                        }
                    });
                });
            }

            $('#startProcessingBtn').click(processQueue);
            fetchAgents();
            fetchCsvAndParse();
            resolveFolderPaths();
            

            //fetchDocuments(rootFolderId);
        });
        function parseJsonFromString(input) {
            // Extract the JSON string between the backticks
            const jsonString = input.replace(/```json\n|\n```/g, '').trim();
            try {
                // Parse the cleaned JSON string
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse JSON:", e);
                return null;
            }
        }
        function appendNamesAndCountToPrompt( documents) {
            // Extract names from the array of JSON objects
            const names = documents.map(doc => doc.name).join(', ');
            
            // Get the number of documents
            const count = documents.length;
            
            // Append the names and the count to the prompt
            return `Categorize these ${count} documents,  ${names}`;
        }
        function fetchCsvAndParse() {
            $.ajax({
                url: 'paths.csv',
                method: "GET",
                success: function (data) {
                    parseCsv(data);
                    resolveFolderPaths();
                },
                error: function (err) {
                    console.error("Error fetching CSV:", err);
                }
            });
        }
        function parseCsv(csvData) {
            let lines = csvData.split("\n");
            lines.forEach(line => {
                let parts = line.split(",");
                if (parts.length === 2) {
                    let category = parts[0].trim();
                    let folderPath = parts[1].trim();
                    categoryToFolderPath[category] = folderPath;
                    table.row.add([category,"0"]).draw();
                }
            });
        }
        function updateFoundStats() {
            console.log(fileFoundCounter);
            $("#dfound").text("Documents found: " + fileFoundCounter);
        }
        function updateProcStats() {
            $("#dproc").text("Documents processed: " + fileProcessedCounter);
        }
        function updateQueueStats() {
            let total = apiQueue.reduce((sum, subArray) => sum + subArray.length, 0);

            $("#dqueue").text("API Queue size: " + apiQueue.length + " (" + total + ")");
        }

        function updateCallsStats() {
            $("#drunning").text("Runnig calls: " + runningCalls);
        }

        const folderCache = {}; // Cache to store resolved folder paths

        
            function resolveFolderPaths() {
                Object.entries(categoryToFolderPath).forEach(([category, path]) => {
                    console.log('resolving' + "->" + path);
                    if (folderCache[path]) {
                        categoryToFolderId[category] = folderCache[path];
                    } else {
                        
                        folderQueue.push({
                            rootId: rootTargetFolder,
                            pathSegments: path.split("/"),
                            index: 0,
                            callback: (folderId) => {
                                if (folderId) {
                                    folderCache[path] = folderId;
                                    categoryToFolderId[category] = folderId;
                                } else {
                                    console.warn(`Could not resolve folder ID for ${path}`);
                                }
                            }
                            
                        });
                        processFolderQueue();
                    }
                });
                
            }
        
        function findOrCreateFolder(parentId, pathParts, index, callback) {
            if (index >= pathParts.length) {
                return callback(parentId);
            }
            
            let folderName = pathParts[index];
            // Check if the folder already exists
            $.ajax({
                url: `https://api.box.com/2.0/folders/${parentId}/items`,
                headers: { Authorization: `Bearer ${boxToken}` },
                method: "GET",
                success: function (response) {
                    let existingFolder = response.entries.find(entry => entry.type === "folder" && entry.name === folderName);
        
                    if (existingFolder) {
                        // Folder exists, move to the next level
                        findOrCreateFolder(existingFolder.id, pathParts, index + 1, callback);
                    } else {
                        // Folder does not exist, create it
                        createFolder(parentId, folderName, (newFolderId) => {
                            if (newFolderId) {
                                findOrCreateFolder(newFolderId, pathParts, index + 1, callback);
                            } else {
                                callback(null); // Creation failed
                            }
                        });
                    }
                },
                error: function () {
                    callback(null);
                }
            });
        }
        
        function createFolder(parentId, folderName, callback) {
            let data = { name: folderName, parent: { id: parentId } };
        
            $.ajax({
                url: `https://api.box.com/2.0/folders`,
                headers: { Authorization: `Bearer ${boxToken}`, "Content-Type": "application/json" },
                method: "POST",
                data: JSON.stringify(data),
                success: function (response) {
                    console.log(`Created folder: ${folderName} (${response.id})`);
                    callback(response.id);
                },
                error: function (error) {
                    if (error.status === 409 && error.responseJSON?.context_info?.conflicts?.length > 0) {
                        // Extract existing folder ID from conflict error
                        let existingFolderId = error.responseJSON.context_info.conflicts[0].id;
                        console.log(`Folder already exists: ${folderName} (${existingFolderId})`);
                        callback(existingFolderId);
                    } else {
                        console.error("Error creating folder:", error);
                        callback(null);
                    }
                }
            });
        }
    
        function copyDocument(fileId, category) {
            if (!categoryToFolderId[category]) {
                console.warn(`No folder ID found for category: ${category}`);
                return;
            }
    
            let destinationFolderId = categoryToFolderId[category];
            let data = { parent: { id: destinationFolderId } };
    
            $.ajax({
                url: `https://api.box.com/2.0/files/${fileId}/copy`,
                headers: { Authorization: `Bearer ${boxToken}`, "Content-Type": "application/json" },
                method: "POST",
                data: JSON.stringify(data),
                success: function () {
                    console.log(`Copied file ${fileId} to folder ${destinationFolderId}`);
                },
                error: function (err) {
                    console.error("Error copying file:", err);
                },
                complete: function () {
                    runningMoves--;
                    //processCopyQueue();
                }
            });
        }
    
        function processCopyQueue() {
            console.log('processing copy queue');
            while (runningMoves < maxConcurrentMoves && moveQueue.length > 0) {
                let { fileId, category } = moveQueue.shift();
                runningMoves++;
                copyDocument(fileId, category);
            }
        }
    
        function queueFileMove(fileId, category) {
            moveQueue.push({ fileId, category });
            //processCopyQueue();
        }

function processFolderQueue() {
    console.log('prcoessing folder queue:' + folderQueue.length); 
   
    while (activeFolderCreations < MAX_CONCURRENT_FOLDER_CREATION && folderQueue.length > 0) {
        const { rootId, pathSegments, index, callback } = folderQueue.shift();
        activeFolderCreations++;
        
        findOrCreateFolder(rootId, pathSegments, index, (folderId) => {
            activeFolderCreations--;
            callback(folderId);
            processFolderQueue(); // Continue processing
        });
    }
    if(folderQueue.length>0) {
        $(".loader").show();
        $(".actions").hide();
    }
    else {

        $(".loader").hide();
        $(".actions").show();
    }
}
        
    </script>
</body>
</html>
