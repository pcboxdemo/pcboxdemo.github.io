<!DOCTYPE html>
<html>

<head>
  <title>MDQ</title>
  <!-- for-mobile-apps -->
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <link rel="stylesheet" href="https://cdn01.boxcdn.net/platform/elements/12.0.0/en-US/explorer.css" />
  <script src="https://cdn01.boxcdn.net/platform/elements/12.0.0/en-US/explorer.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="mdq.css">
  <script>
    //var token = 'ZYBeg0yrkCdCobfDansJgrMy7w0dxih2';
    var boxId = "124092627842";
    var contentExplorer = new Box.ContentExplorer();
    var tab = "nav-progress";
    var status = "In Progress";
    var token;
    var template;
    var filters;
    var orderBy;
    var orderByDirection;
    var columns;
    var dateFormat;
    var loaded = false;
    var firstFilter = null;
    var oldStartDate;
    var oldEndDate;
    $(document).ready(function () {


      $("#loader").show();
      $(".container1").hide();
      var params = new URLSearchParams(window.location.search);
      var code = params.get('auth');
      var ptoken = params.get('token');
      var url = params.get('url');
      if (code == null) {
        code = params.get('code');
      }
      if (url == null) {
        url = "https://box-tokengenerator-v2.herokuapp.com/mdqtoken";
      }
      var clientId = params.get('clientId');//"of926g5v0mqi50dpiislr1avju7h3jl8";
      boxId = params.get('id');
      if (boxId == null) {
        boxId = '0';
      }
      var urlParams = "id=" + boxId + "&code=" + code + "&clientId=" + clientId + (ptoken != null ? "&token=" + ptoken : "");

      $.ajax({
        method: 'get',
        //url:"https://89w694ee39.execute-api.eu-west-2.amazonaws.com/default/box-token-generator-mdq?"+urlParams,
        //url:"https://box-tokengenerator-v2.herokuapp.com/mdqtoken?"+urlParams,
        url: url + "?" + urlParams,
        crossDomain: true,
        cache: false,
        success: function (response) {
          token = response.token;
          template = response.template;//'abb'
          filters = response.filters;//{ 'region': { 'Region': 'North America' }, 'priorityStatus': { 'Priority Status': 'High,Medium,Low' }, 'workflowStatus': { 'Workflow Status': 'In Progress,Coordinate,Review,Published' } };//response.filters;
          columns = response.columns;//'region,priorityStatus,workflowStatus,owner,contentFormat,responsibleOrganisation';//response.columns;
          eid = response.eid;//'210762180';//response.eid
          orderBy = response.orderBy;
          dateFormat = response.dateFormat;
          orderByDirection = response.orderByDirection;
          if (dateFormat == undefined) {
            dateFormat = 'yy-mm-dd';
          }
          loadTab("nav-container", true);
        },
        error: function (err) {
          console.log(JSON.stringify(err));
          console.log("error:" + err.message);
          $("#loader").text(err.responseText);

        }
      });

      $(".filter").change(function () {
        if (loaded) {
          contentExplorer.clearCache();
          contentExplorer.hide();
        }
        loadTab(tab, false);

      });
      $(".datepicker").change(function () {

        if (loaded) {
          contentExplorer.clearCache();
          contentExplorer.hide();
        }
        loadTab(tab, false);

      });


    });
    function loadTab(tabName, buildFilters) {
      if (loaded) {
        $(".form-control").prop("disabled", true);
      }
      delim = "";
      var col = columns.split(',');
      var query = "";

      var query_params = "";
      var index;
      var delim = "";

      var fields = [];
      var fieldsToShow = [];
      col.forEach(element => fields.push('metadata.enterprise_' + eid + "." + template + "." + element));
      col.forEach(element => fieldsToShow.push({ key: 'metadata.enterprise_' + eid + "." + template + "." + element, canEdit: true }));
      if (buildFilters) {
        $.each(filters, function (index, filter) {
          if (firstFilter == null) {
            firstFilter = filter.key;
          }
          $("#filters").append(getHTMLForFilter(filter));
          if (filter.type == 'date') {
            $("#" + filter.key).datepicker({ "dateFormat": dateFormat, changeYear: true });
          }
        });
      }
      $(".datepicker").datepicker({ dateFormat: dateFormat, changeYear: true });
      $(".filter").change(function () {
        if (loaded) {
          contentExplorer.clearCache();
          contentExplorer.hide();
        }
        loadTab(tab, false);

      });
      $(".filterD").change(function () {

        $(".datepicker").val("");
        if ($(this).val() == 'All') {
          $(".datepicker").hide();
          $(".input-containerStart").hide();
          $(".input-containerEnd").hide();

        }
        else if ($(this).val() == 'Between') {
          $(".datepickerEnd").show();
          $(".datepickerStart").show();
          $(".input-containerStart").show();
          $(".input-containerEnd").show();
        }
        else if ($(this).val() == 'On' || $(this).val() == 'Before' || $(this).val() == 'After') {
          $(".datepickerEnd").hide();
          $(".datepickerStart").show();
          $(".input-containerStart").show();
          $(".input-containerEnd").hide();
        }

      });
      $(".datepicker").change(function () {
        if ($(this).val() == $(this).attr("oldVal")) {
          console.log("Changed but same val");
        }
        else {
          console.log("Changed new val");
          $(this).attr("oldVal", $(this).val());
          if ($(".filterD").val() == 'Between') {
            var fid = $(this).attr("id");
            if ($("#" + fid + "_end").val() == '' || $("#" + fid).val() == '') {
              return;
            }
          }
          if (loaded) {
            contentExplorer.clearCache();
            contentExplorer.hide();
          }

          loadTab(tab, false);
        }
      });
      query_params += '{';
      $.each(filters, function (k, filter) {

        if (filter.type == 'date') {
          if ($('#' + filter.key + '_date').val() != '') {
            query_params += delim + '"' + filter.key + '":"' + $('#' + filter.key + '_date').val() + "T00:00:00Z" + '"';
            if ($(".filterD").val() == 'Between') {
              query_params += delim + '"' + filter.key + '_end":"' + $('#' + filter.key + '_date_end').val() + "T00:00:00Z" + '"';
            }
          }
        }
        else if (isNaN($('#' + filter.key).val())) {
          query_params += delim + '"' + filter.key + '":"' + $('#' + filter.key).val() + '"';
        }
        else {
          query_params += delim + '"' + filter.key + '":' + $('#' + filter.key).val() + '';
        }
        delim = " , ";
      });
      query_params += '}';
      delim = "";
      $.each(filters, function (k, filter) {
        if (filter.type != 'date') {
          if ($('#' + filter.key).val() != 'All') {
            query += delim + filter.key + "=:" + filter.key;
            delim = " AND ";
          }
        }
        else if (filter.type == 'date' && $('#' + filter.key + '_date').val() != '') {

          var symbol;
          if ($('#' + filter.key).val() == 'On') {
            symbol = "=:";
            query += delim + filter.key + symbol + filter.key;
          }
          else if ($('#' + filter.key).val() == 'Before') {
            symbol = "<:";
            query += delim + filter.key + symbol + filter.key;
          }
          else if ($('#' + filter.key).val() == 'After') {
            symbol = ">:";
            query += delim + filter.key + symbol + filter.key;
          }
          else if ($('#' + filter.key).val() == 'Between') {
            query += delim + "(" + filter.key + ">:" + filter.key + " AND " + filter.key + "<:" + filter.key + "_end)";
          }

          //val = "{%22gt%22:\"" + sD + "T00:00:00Z" + "\",%22lt%22:\"" + eD + "T00:00:00Z" + "\"}";

        }
      });
      if (query == '') {
        query = firstFilter + ' IS NOT NULL OR ' + firstFilter + ' IS NULL';
      }

      const mdQuery = {
        from: "enterprise_" + eid + "." + template,
        query: query,
        limit: 20,
        query_params: JSON.parse(query_params),
        ancestor_folder_id: boxId,
        fields: fields
      };
      console.log("reloading:" + JSON.stringify(mdQuery));
      // The metadata fields/columns to view - must be valid field names from the metadata template
      loaded = true;
      const defaultView = "metadata";
      contentExplorer.show(boxId, token, {
        container: '#nav-container',
        metadataQuery: mdQuery,
        fieldsToShow: fieldsToShow,
        defaultView: defaultView,
        contentPreviewProps: {
          contentSidebarProps: {
            detailsSidebarProps: {
              hasNotices: true,
              hasProperties: true,
              hasAccessStats: true,
              hasVersions: true
            },
            hasActivityFeed: true,
            hasSkills: true,
            hasMetadata: true
          }
        }

      });
      $("#loader").hide();
      $(".container1").show();
      $(".form-control").prop("disabled", false);
    }

    function getHTMLForFilter(filter) {
      var disp = filter.displayName;
      var key = filter.key;
      var options = filter.values;
      var html;
      var sclass = (filter.type == 'date' ? "filterD" : "filter");
      html = '<label class="bea" for="' + key + '">' + disp + '</label>' +
        '<select class="form-control ' + sclass + ' bea1"  style="height:35px" id="' + key + '" required>';
      html += '<option>All</option>';

      $.each(options, function (k, val) {
        html += '<option>' + val + '</option>';
      });

      html += '</select>';
      if (filter.type == 'date') {
        html += ' <div class="input-containerStart" style="display:none;"><i class="fa fa-calendar icon"></i><input autocomplete="off" class="bea1 input-field form-control datepicker datepickerStart" style="display:none;" type="text" name="' + filter.key + '_date" id="' + filter.key + '_date" ></div>';
        html += '<div class="input-containerEnd" style="display:none;" > <i class="fa fa-calendar icon"></i><input autocomplete="off" class="bea1 input-field form-control datepicker datepickerEnd"  style="display:none;" type="text" name="' + filter.key + '_date_end" id="' + filter.key + '_date_end" ></div>';

      }
      return html;
    }
  </script>

</head>

<body>
  <div class="container1">
    <div class="normal-div" id="div-1">
      <div style="margin-top:50px;" id="filters">


      </div>
    </div>
    <div class="normal-div" id="div-2">
      <div id="nav-container" role="tabpanel" aria-labelledby="nav-progress-tab" style="height:750px;">

      </div>

    </div>

  </div>
  <div id='loader' class='center'>
    <img src='l.gif' />
  </div>



</html>